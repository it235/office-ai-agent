<!DOCTYPE html>
<html>
<head>
    <meta charset="GBK">
    <title>Excel Ai Chat Content</title>
<!-- 先加载核心库 -->
<script src="https://officeai.local/js/highlight.min.js"></script>
<link rel="stylesheet" href="https://officeai.local/css/github.min.css">
<!-- 确保核心库加载完成后再加载语言包 -->
<script>
    // 添加调试日志
    console.log('Initializing scripts...');
    
    // 检查 highlight.js 是否加载
    if (typeof hljs !== 'undefined') {
        console.log('highlight.js loaded successfully');
    } else {
        console.error('highlight.js not loaded');
    }
</script>
<script src="https://officeai.local/js/marked.min.js"></script>
<script src="https://officeai.local/js/vbscript.min.js"></script>

    <script>
        hljs.registerAliases('vba', { languageName: 'vbscript' });
        hljs.highlightAll();
    </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            line-height: 1.5;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f9f9f9;
            padding-bottom: 160px;
        }

        #chat-output {
            /* white-space: pre-wrap; */
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        pre {
            position: relative;
            margin: 1em 0;
            border-radius: 6px;
            background-color: #f6f8fa;
            overflow: hidden;
        }

            pre code {
                display: block;
                padding: 12px;
                overflow-x: auto;
                font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
                font-size: 13px;
                line-height: 1.4;
            }

        .code-buttons {
            display: flex;
            justify-content: flex-start;
            padding: 4px 8px;
            background-color: #f0f0f0;
            border-top: 1px solid #ddd;
        }

        .code-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 4px 8px;
            margin-left: 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
        }

            .code-button:hover {
                background-color: #45a049;
            }

            .code-button svg {
                margin-right: 4px;
                width: 14px;
                height: 14px;
            }

        .edit-button {
            background-color: #FF9800;
        }

            .edit-button:hover {
                background-color: #F57C00;
            }

        .execute-button {
            background-color: #2196F3;
        }

            .execute-button:hover {
                background-color: #0b7dda;
            }

        .code-editor {
            width: 100%;
            min-height: 100px;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            font-size: 13px;
            line-height: 1.4;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
        }

        .editor-buttons {
            display: flex;
            justify-content: flex-start;
            margin-top: 8px;
            margin-bottom: 20px;
        }

        p {
            margin: 0.5em 0;
        }

        /* 发起人信息样式 */
        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
            color: #555;
        }

        .avatar-ai {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #4a6fa5;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
            font-size: 12px;
        }

        .sender-name {
            font-weight: 500;
            margin-right: 8px;
        }

        .timestamp {
            color: #888;
            font-size: 12px;
        }

        .sender-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .message-content {
            margin-left: 32px;
        }

        .chat-container {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e6e6e6;
        }

        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .avatar-me {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #39b362;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
            font-size: 12px;
        }

        .sender-name {
            font-weight: 500;
            margin-right: 10px;
        }

        .timestamp {
            color: #888;
            font-size: 12px;
        }

        .reasoning-container {
            margin: 0 0 15px 42px;
            border-radius: 8px;
            background-color: #f8f9fa;
            overflow: hidden;
            transition: all 0.3s ease;
            max-height: 500px;
            border: 1px solid #e0e5eb;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

            .reasoning-container.collapsed {
                max-height: 38px;
            }

        .reasoning-header {
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #edf2f7;
            cursor: pointer;
            user-select: none;
            border-bottom: 1px solid #e0e5eb;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .reasoning-title {
            font-weight: 500;
            color: #4a6fa5;
            display: flex;
            align-items: center;
        }

            .reasoning-title svg {
                width: 16px;
                height: 16px;
                margin-right: 6px;
                fill: #4a6fa5;
            }

        .reasoning-toggle svg {
            width: 16px;
            height: 16px;
            fill: #4a6fa5;
            transition: transform 0.2s ease;
        }

        .collapsed .reasoning-toggle svg {
            transform: rotate(-90deg);
        }

        .reasoning-content {
            padding: 12px 15px;
            font-size: 0.9em;
            color: #444;
            line-height: 1.5;
            overflow-wrap: break-word;
            background-color: #f8f9fa;
            max-height: none;
            overflow-y: auto;
        }

        .collapsed .reasoning-content {
            display: none;
        }

        .message-content {
            margin-left: 42px;
            line-height: 1.6;
        }

        /* 代码块样式优化 */
        pre {
            background-color: #f6f8fa;
            border-radius: 6px;
            padding: 12px;
            overflow: auto;
        }

        code {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 0.9em;
        }

        .code-toggle-label {
            cursor: pointer;
            color: #4a6fa5;
            padding: 4px 8px;
            font-size: 12px;
            background: #edf2f7;
            border-radius: 4px 4px 0 0;
            border: 1px solid #e0e5eb;
            border-bottom: none;
            margin-top: 10px;
        }

        .code-toggle-label:hover {
            background: #e3eaf3;
        }

        pre.collapsible {
            margin-top: 0;
            transition: max-height 0.3s ease-out;
/*            max-height: 500px;*/
            overflow: hidden;
        }

        pre.collapsible.collapsed {
            max-height: 0;
            margin-bottom: 10px;
        }

        .code-block {
            margin-top: -1px; /* 确保和toggle-label无缝衔接 */
        }

        /* 动画效果 */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .reasoning-content, .message-content {
            animation: fadeIn 0.3s ease-in-out;
        }

        /* 当内容超过一定高度时自动调整容器高度 */
        .reasoning-container:not(.collapsed) {
            display: flex;
            flex-direction: column;
            max-height: 80vh;
        }

        .reasoning-content {
            flex-grow: 1;
        }

        #case-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
            overflow: hidden;
            border: 1px solid #e6e6e6;
        }

        #case-header {
            background: linear-gradient(135deg, #4a6fa5 0%, #3d5a7c 100%);
            padding: 5px 25px;
            color: white;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

            #case-header h2 {
                margin: 0;
                font-size: 1.3em;
                font-weight: 400;
                letter-spacing: 0.5px;
            }

        #case-content {
            padding: 10px;
        }

        #case-info {
            color: #444;
            line-height: 1.3;
        }

            #case-info p {
                margin: 10px 0;
                font-size: 0.75em;
                display: flex;
                align-items: flex-start;
            }

                #case-info p:before {
                    color: #4a6fa5;
                    font-weight: bold;
                    margin-right: 10px;
                    margin-top: 2px;
                }

            #case-info a {
                color: #4a6fa5;
                text-decoration: none;
                font-weight: 500;
                position: relative;
                transition: all 0.2s ease;
                padding: 0 2px;
            }

                #case-info a:hover {
                    color: #3d5a7c;
                    text-decoration: none;
                }

                #case-info a:after {
                    content: '';
                    position: absolute;
                    width: 100%;
                    height: 1px;
                    bottom: -1px;
                    left: 0;
                    background-color: #4a6fa5;
                    transform: scaleX(0);
                    transform-origin: right;
                    transition: transform 0.3s ease;
                }

                #case-info a:hover:after {
                    transform: scaleX(1);
                    transform-origin: left;
                }

        #version {
            background: #f0f4f8;
            padding: 1px 6px;
            border-radius: 4px;
            font-size: 0.8em;
            color: #4a6fa5;
            font-weight: 500;
        }

        #chat-input-card {
            position: sticky;
            width: 100%;
            bottom: 0;
            background: #fff;
            box-shadow: 0 -2px 12px rgba(0,0,0,0.06);
            border-radius: 12px;
            padding: 12px 16px 8px 16px;
            z-index: 100;
        }

        #chat-input-inner {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        /* 提示词建议样式 */
        #prompt-suggestions {
            border: 1px solid #e0e0e0;
            border-bottom: none; /* 避免与textarea上边框重复 */
            border-radius: 6px 6px 0 0;
            max-height: 150px;
            overflow-y: auto;
            background-color: #fff;
        }

        .prompt-suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            color: #333;
            border-bottom: 1px solid #f0f0f0;
        }

        .prompt-suggestion-item:last-child {
            border-bottom: none;
        }

        .prompt-suggestion-item:hover {
            background-color: #f9f9f9;
        }
        #chat-input {
            width: 100%;
            min-height: 38px;
            max-height: 120px;
            resize: none;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 15px;
            padding: 8px 12px;
            box-sizing: border-box;
            font-family: inherit;
            outline: none;
            transition: border 0.2s;
        }

            #chat-input:focus {
                border: 1.5px solid #4a6fa5;
            }

        #chat-input-actions {
            width: 100%;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 2px;
        }

        #send-button {
            background: rgb(175 184 191);
            border: none;
            border-radius: 6px;
            padding: 2px 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background 0.2s;
        }

            #send-button:hover {
                background: #688ec5;
            }

        .input-option {
            display: flex;
            align-items: center;
            gap: 3px;
            font-size: 13px;
            color: #555;
        }

        #ai_model_select {
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 13px;
            background: #fafbfc;
        }

        @media (max-width: 600px) {
            #chat-input-card {
                max-width: 100%;
                padding: 8px 4px 4px 4px;
            }
        }

        #chat-bottom-bar {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 200;
            background: #fff;
            box-shadow: 0 -2px 12px rgba(0,0,0,0.06);
            display: flex;
            flex-direction: column;
            align-items: stretch;
            padding: 0 16px 8px 16px;
            box-sizing: border-box;
            margin-left: auto;
            margin-right: auto;
            width: 100%;
        }

        @media (min-width: 832px) {
            #chat-bottom-bar {
                left: 50%;
                transform: translateX(-50%);
                width: 800px;
                max-width: 100vw;
                padding-left: 0;
                padding-right: 0;
            }
        }
        #references-wrapper {
            width: 100%;
            background: #f8f9fa; /* 浅灰色背景，使其与输入区域略有区分 */
            border-radius: 8px; /* 圆角与输入框协调 */
            padding: 8px 12px; /* 内部留白 */
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); /* 轻微阴影增加层次感 */
            margin-bottom: 8px; /* 与下方元素的间距 */
            box-sizing: border-box;
        }

        /* 引用区域标题 ("引用:") */
        .reference-section-title { /* 此类名已在HTML中指定给新的 span#references-title */
            font-size: 13px; /* 稍微增大字号 */
            color: #333; /* 深灰色，更清晰 */
            margin-bottom: 8px; /* 标题与芯片之间的间距 */
            display: block;
            font-weight: 500;
        }

        /* 包含所有引用项 (chips) 的容器 */
        .reference-chips-container { /* 此类名已在HTML中指定给新的 div#reference-chips-list */
            max-height: 70px; /* 调整最大高度以适应内容 */
            overflow-y: auto;
            width: 100%;
            line-height: 0;
            padding-top: 2px;
        }

        /* 单个引用项 (chip) */
        .reference-chip {
            display: inline-block;
            vertical-align: top;
            background-color: #e9ecef; /* 调整chip背景色 */
            border: 1px solid #ced4da; /* 调整chip边框色 */
            border-radius: 16px;
            padding: 4px 10px 5px 10px; /* 微调内边距 */
            font-size: 12px; /* 调整字体大小 */
            color: #212529; /* 调整文字颜色 */
            box-shadow: none; /* 移除单个chip的阴影，由外部wrapper统一处理 */
            transition: background-color 0.2s, border-color 0.2s;
            margin-right: 6px;
            margin-bottom: 6px;
            line-height: normal;
            max-width: 230px; /* 限制单个chip的最大宽度 */
            cursor: default; /* 默认光标 */
        }

        .reference-chip:hover {
            background-color: #dee2e6; /* hover时颜色加深 */
            border-color: #adb5bd;
        }

        .reference-chip-content-wrapper {
            display: flex;
            align-items: center;
        }

        .reference-chip-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 8px;
            flex-grow: 1; /* Allows name to take space if content-wrapper is flex */
            min-width: 0; /* Helps with ellipsis in flex item */
        }

        .reference-chip-remove {
            cursor: pointer;
            color: #6c757d; /* 移除按钮颜色调整 */
            font-size: 15px;
            border: none;
            background: none;
            outline: none;
            display: flex;
            align-items: center;
            padding: 0;
            flex-shrink: 0;
            transition: color 0.2s;
        }

        .reference-chip-remove:hover {
            color: #343a40; /* hover时移除按钮颜色加深 */
        }
        .reference-chip-remove svg {
            width: 16px;
            height: 16px;
            fill: currentColor; /* 使SVG颜色随父元素color属性变化 */
        }

        .reference-container {
            margin: 8px 0 0 42px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e0e5eb;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            overflow: hidden;
            transition: max-height 0.2s;
            max-width: 90%;
        }

        .reference-header {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 6px 12px;
            background: #eaf1fb;
            user-select: none;
        }

        .reference-arrow {
            display: inline-block;
            transition: transform 0.2s;
            margin-right: 6px;
        }

        .reference-container:not(.collapsed) .reference-arrow {
            transform: rotate(90deg);
        }

        .reference-content {
            padding: 8px 16px;
            display: block;
            font-size: 13px;
            color: #3a4a6b;
        }

        .reference-container.collapsed .reference-content {
            display: none;
        }

        .reference-item {
            margin-bottom: 4px;
            color: #2b4a8a;
        }
        #chatMode {
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 13px;
            background: #fafbfc;
            color: #555;
            cursor: pointer;
            outline: none;
        }

        #chatMode:hover {
            border-color: #4a6fa5;
        }

        #chatMode:focus {
            border-color: #4a6fa5;
            box-shadow: 0 0 0 2px rgba(74, 111, 165, 0.1);
        }

        #stop-button {
            background: #e9525f;
            border: none;
            border-radius: 6px;
            padding: 6px; /* 调整padding使按钮更紧凑 */
            cursor: pointer;
            display: none;   
            align-items: center;
            justify-content: center; /* 居中显示方块 */
            transition: background-color 0.2s;
        }

        #stop-button:hover {
            background: #c82333;
        }

        .message-footer {
            margin-left: 42px;
            margin-top: 8px;
            font-size: 12px;
            color: #888;
            display: flex;
            justify-content: flex-end;
        }

        .token-count {
            background: #f0f4f8;
            padding: 2px 6px;
            border-radius: 4px;
            color: #4a6fa5;
        }

        /* 设置按钮样式 */
        #settings-button {
            background: none;
            border: none;
            padding: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            transition: color 0.2s;
        }

            #settings-button:hover {
                color: #4a6fa5;
            }

        /* 设置dialog对话框样式 */
        .settings-dialog {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            width: 300px;
            z-index: 1000;
        }

        .settings-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 20px;
            color: #333;
        }

        .setting-item {
            margin-bottom: 20px;
        }

        .setting-item.checkbox-item {
            display: block; /* 改为块级显示而不是 flex */
        }

        .setting-item.checkbox-item .setting-label {
            display: inline-block;
            margin-bottom: 4px;
        }

        .setting-item.checkbox-item .setting-tip {
            display: block;
            margin-top: 4px;
            color: #666;
            font-size: 12px;
        }

        .setting-label {
            display: block;
            font-weight: 500;
/*            margin-bottom: 4px;*/
            color: #333;
        }

        .setting-tip {
            font-size: 12px;
            color: #666;
/*            margin-bottom: 8px;*/
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .slider {
            flex-grow: 1;
            height: 4px;
            -webkit-appearance: none;
            background: #e0e0e0;
            border-radius: 2px;
            outline: none;
        }

            .slider::-webkit-slider-thumb {
                -webkit-appearance: none;
                width: 16px;
                height: 16px;
                border-radius: 50%;
                background: #4a6fa5;
                cursor: pointer;
                transition: background .15s ease-in-out;
            }

                .slider::-webkit-slider-thumb:hover {
                    background: #3d5a7c;
                }

        .slider-value {
            min-width: 40px;
            text-align: center;
            font-size: 14px;
            color: #666;
        }

        .settings-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .settings-button {
            padding: 6px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .cancel-button {
            background: #f5f5f5;
            color: #333;
        }

            .cancel-button:hover {
                background: #e0e0e0;
            }

        .save-button {
            background: #4a6fa5;
            color: white;
        }

            .save-button:hover {
                background: #3d5a7c;
            }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        /**附件显示区域*/
        #chat-input-actions button {
            background: none;
            border: none;
            padding: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            transition: color 0.2s, background-color 0.2s;
        }

        #chat-input-actions button:hover {
            color: #4a6fa5;
            background-color: #f0f0f0;
        }

        #send-button { /* Specific override if needed, or adjust general style */
            background: rgb(175 184 191);
            border-radius: 6px;
            padding: 2px 8px; /* Keep your original send button padding */
            color: white; /* Assuming send button icon was white */
        }

        #send-button:hover {
            background: #688ec5;
        }

        #stop-button {
            background: #e9525f;
            padding: 6px; 
            border-radius: 6px;
            color: white; 
        }

        #stop-button:hover {
            background: #c82333;
        }

        #chat-input-actions button#attach-file-button {
            padding: 4px;
        }

        /* 附件显示区域样式 */
        #attached-files-list .attached-file-item {
            display: none !important;
            justify-content: space-between;
            align-items: center;
            background-color: #f0f4fa;
            border: 1px solid #d0d8e8;
            border-radius: 4px;
            padding: 3px 8px;
            font-size: 12px;
            color: #3a4a6b;
        }

        #attached-files-list .attached-file-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 8px;
        }

        #attached-files-list .remove-attached-file {
            cursor: pointer;
            color: #b71c1c;
            font-size: 14px;
            background: none;
            border: none;
            padding: 0;
        }

        #attached-files-list .remove-attached-file svg {
            width: 14px;
            height: 14px;
            fill: #b71c1c;
        }

        /**聊天内容引用的逻辑*/
        .chat-message-references {
            margin-top: 10px;
            border: 1px solid #e0e5eb;
            border-radius: 6px;
            background-color: #f8f9fa;
            overflow: hidden;
        }

        .chat-message-reference-header {
            display: flex;
            align-items: center;
            padding: 6px 10px;
            cursor: pointer;
            background-color: #edf2f7;
            user-select: none;
            border-bottom: 1px solid #e0e5eb;
        }

        .chat-message-references.collapsed .chat-message-reference-header {
            border-bottom: none; /* No bottom border when collapsed */
        }

        .chat-message-reference-arrow {
            display: inline-block;
            transition: transform 0.2s ease-in-out;
            margin-right: 8px;
            font-size: 10px; /* Smaller arrow */
            color: #4a6fa5;
        }

        .chat-message-references.collapsed .chat-message-reference-arrow {
            transform: rotate(-90deg);
        }

        .chat-message-references:not(.collapsed) .chat-message-reference-arrow {
            transform: rotate(0deg); /* Pointing down when expanded */
        }


        .chat-message-reference-label {
            font-weight: 500;
            font-size: 13px;
            color: #4a6fa5;
        }

        .chat-message-reference-content {
            padding: 8px 12px;
            font-size: 12px;
            color: #333;
            line-height: 1.5;
            max-height: 200px; /* Limit height when expanded */
            overflow-y: auto;
        }

        .chat-message-references.collapsed .chat-message-reference-content {
            display: none;
        }

        .chat-message-reference-content div { /* Each item in the content */
            margin-bottom: 4px;
            word-break: break-all; /* Break long file names or paths */
        }

        .chat-message-reference-content div:last-child {
            margin-bottom: 0;
        }
    </style>
</head>
<body>


    <div id="case-container">
        <div id="case-header">
            <h3>智能聊天模式说明</h3>
        </div>
        <div id="case-content">
            <div id="case-info">
                <p>1.试试按#号快速提问</p>
                <p>2.会话已自动开启上下文，您可通过不断提问纠正AI的回答</p>
                <p>3.使用前请配置大模型Api，<a href="https://cloud.siliconflow.cn/i/PGhr3knx" target="_blank">点此取免费额度</a></p>
                <p>4.配置大模型提示词能够更快，更准确的得到你想要的答案</p>
                <p>5.如果没解决你的痛点，<a href="https://jsj.top/f/OZJDfa" target="_blank">点击此处提出需求</a>，下个版本见</p>
                <p>6.聊天记录存放在“当前用户/文档/OfficeAiAppData”目录下</p>
                <p>7.当前版本:<span id="version">1.5.0</span>，<a href="https://www.officeso.cn" target="_blank">每月发布新功能</a></p>
            </div>
        </div>
    </div>

    <div id="chat-container">
        <!-- message content list -->
    </div>

    <!-- message chat input bottom -->
    <div id="chat-bottom-bar">

        <!-- message input -->
        <div id="chat-input-card">
            <div id="chat-input-inner">
                <!-- 合并后的引用区域 -->
                <div id="references-wrapper" style="display:none;">
                    <span id="references-title" class="reference-section-title">引用:</span>
                    <div id="reference-chips-list" class="reference-chips-container">
                        <!-- 所有引用项（工作表内容和文件）将在此处动态添加 -->
                    </div>
                </div>

                <div id="prompt-suggestions" style="display: none;">
                    <!-- 提示词项将在此处动态添加 -->
                </div>
                <textarea id="chat-input" placeholder="请在此输入您的问题... 按Enter键直接发送，Shift+Enter换行" rows="2"></textarea>
                <div id="chat-input-actions">

                    <button id="settings-button" title="设置" onclick="settingsButton()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                        </svg>
                    </button>

                    <label class="input-option">
                        <select id="chatMode" onchange="chatModeChanged(this)">
                            <option value="chat">Chat模式</option>
                            <option value="agent">Agent模式</option>
                        </select>
                    </label>

                    <!-- 新增：附件按钮 -->
                    <button id="attach-file-button" title="添加附件" style="padding: 4px;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
                        </svg>
                    </button>
                    <input type="file" id="file-input" multiple style="display: none;" accept=".xls,.xlsx,.xlsm,.xlsb,.csv,.doc,.docx,.ppt,.pptx">

                    <button id="send-button" title="发送">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 20px; height: 20px;">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </button>
                    <!--style="display: none;"-->
                    <!-- 修改后 -->
                    <button id="stop-button" title="取消" onclick="stopButton()">
                        <div style="width: 14px; height: 12px;  border-radius: 2px;"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- 添加设置对话框 -->
    <div class="overlay" id="settings-overlay"></div>
    <div class="settings-dialog" id="settings-dialog">
        <div class="settings-title">聊天设置</div>

        <div class="setting-item checkbox-item">
            <div>
                <label class="setting-label">实时滚动</label>
                <input type="checkbox" id="settings-scroll-checked">
            </div>
            <div class="setting-tip">开启后会自动滚动到最新的对话内容</div>
        </div>

        <div class="setting-item checkbox-item">
            <div>
                <label class="setting-label">选中辅助</label>
                <input type="checkbox" id="settings-selected-cell">
            </div>
            <div class="setting-tip">开启后可以选择并引用工作表内容</div>
        </div>

        <div class="setting-item">
            <label class="setting-label">话题随机性</label>
            <div class="setting-tip">较高的数值会使同问题每次输出的结果更随机</div>
            <div class="slider-container">
                <input type="range" class="slider" id="topic-randomness" min="0.1" max="1.6" step="0.1" value="0.8">
                <span class="slider-value" id="topic-randomness-value">0.8</span>
            </div>
        </div>

        <div class="setting-item">
            <label class="setting-label">上下文数量限制</label>
            <div class="setting-tip">单条回复记录对话数，每次想让ai记住历史多少条对话</div>
            <div class="slider-container">
                <input type="range" class="slider" id="context-limit" min="1" max="10" value="5">
                <span class="slider-value" id="context-limit-value">5</span>
            </div>
        </div>

        <div class="settings-buttons">
            <button class="settings-button cancel-button" id="settings-cancel" onclick="settingsCancel()">取消</button>
            <button class="settings-button save-button" id="settings-save" onclick="settingsSave()">保存</button>
        </div>
    </div>

    <script type="text/javascript">
        // config marked
        marked.setOptions({
            highlight: function (code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            },
            breaks: true,
            gfm: true
        });

        // extends marked renderer
        const renderer = new marked.Renderer();
        const originalCodeRenderer = renderer.code;

        renderer.code = function (code, language, isEscaped) {
            const codeHtml = originalCodeRenderer.call(this, code, language, isEscaped);

            // add button
            return `
                                                        <div class="code-block">
                                                            ${codeHtml}
                                                            <div class="code-buttons">
                                                                <button class="code-button copy-button" onclick="copyCode(this)">
                                                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                                                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                                                    </svg>
                                                                    复制
                                                                </button>
                                                                <button class="code-button edit-button" onclick="editCode(this)">
                                                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                                                    </svg>
                                                                    编辑
                                                                </button>
                                                                <button class="code-button execute-button" onclick="executeCode(this)">
                                                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                                                    </svg>
                                                                    执行
                                                                </button>
                                                            </div>
                                                        </div>
                                                    `;
        };

        marked.use({ renderer });

        function copyCode(button) {
            const codeBlock = button.closest('.code-block');
            const codeElement = codeBlock.querySelector('code');
            const code = codeElement.textContent;

            // craete temp text area
            const textarea = document.createElement('textarea');
            textarea.value = code;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);

            try {
                textarea.select();
                textarea.setSelectionRange(0, 99999);
                document.execCommand('copy');

                const originalText = button.innerHTML;
                button.innerHTML = `
                                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                                <polyline points="20 6 9 17 4 12"></polyline>
                                                            </svg>
                                                            已复制
                                                        `;
                setTimeout(() => {
                    button.innerHTML = originalText;
                }, 2000);
            } catch (err) {
                console.error('copy failure:', err);
                alert('copy failure');
            } finally {
                // clean
                document.body.removeChild(textarea);
            }
        }

        function executeCode(button) {
            const codeBlock = button.closest('.code-block');
            const codeElement = codeBlock.querySelector('code');
            const code = codeElement.textContent;
            const language = codeElement.className.replace('language-', '');

            try {
                // check env is WebView2
                if (window.chrome && window.chrome.webview) {
                    // ues WebView2
                    window.chrome.webview.postMessage({
                        type: 'executeCode',
                        code: code,
                        language: language
                    });
                } else if (window.vsto) {
                    // user inject vsto object
                    window.vsto.executeCode(code, language);
                } else {
                    alert('无法执行代码：未检测到支持的通信接口');
                }

                const originalText = button.innerHTML;
                button.innerHTML = `
                                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                                            </svg>
                                                            已执行
                                                        `;
                setTimeout(() => {
                    button.innerHTML = originalText;
                }, 2000);
            } catch (err) {
                alert('执行失败：' + err.message);
            }
        }

        class MarkdownStreamRenderer {
            constructor(element) {
                this.output = element instanceof HTMLElement ? element : document.getElementById(element);
                this.fullContent = '';
            }

            append(text) {
                this.fullContent += text + '';

                // use full content render
                this.output.innerHTML = marked.parse(this.fullContent);

                // code highlight
                this.output.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });

            }
        }


        // 确保所有函数都在全局作用域中定义
        window.rendererMap = {};
        window.reasoningRendererMap = {};

        // 创建聊天区域，包含发送者信息和内容区域，但不包含推理区域
        window.createChatSection = function (sender, timestamp, uuid) {

            // 创建聊天容器
            const chatContainer = document.createElement('div');
            chatContainer.className = 'chat-container';
            chatContainer.id = 'chat-' + uuid;

            // 创建发送者信息区域
            const messageHeader = document.createElement('div');
            messageHeader.className = 'message-header';

            // 添加头像
            const avatar = document.createElement('div');
            if (sender !== 'Me') {
                avatar.innerHTML = 'AI';
                avatar.className = 'avatar-ai';
            } else {
                avatar.innerHTML = 'Me';
                avatar.className = 'avatar-me';
            }
            messageHeader.appendChild(avatar);

            // 添加发送者名称和时间戳
            const senderInfo = document.createElement('div');
            senderInfo.className = 'sender-info';

            const senderName = document.createElement('div');
            senderName.className = 'sender-name';
            senderName.textContent = sender;

            const timestampElem = document.createElement('div');
            timestampElem.className = 'timestamp';
            timestampElem.textContent = timestamp;

            senderInfo.appendChild(senderName);
            senderInfo.appendChild(timestampElem);
            messageHeader.appendChild(senderInfo);

            chatContainer.appendChild(messageHeader);

            // 创建内容区域
            const contentContainer = document.createElement('div');
            contentContainer.className = 'message-content';
            contentContainer.id = 'content-' + uuid;
            chatContainer.appendChild(contentContainer);

            // 添加footer区域
            const footerContainer = document.createElement('div');
            footerContainer.className = 'message-footer';
            footerContainer.id = 'footer-' + uuid;
            chatContainer.appendChild(footerContainer);

            // 将聊天容器添加到聊天容器
            const chatHistoryContainer = document.getElementById('chat-container');
            if (chatHistoryContainer) {
                chatHistoryContainer.appendChild(chatContainer);
            } else {
                console.error('找不到 chat-container 元素，请确保页面中存在此元素');
                document.body.appendChild(chatContainer); // 回退到添加到 body
            }

            // 创建渲染器
            window.rendererMap[uuid] = new MarkdownStreamRenderer(contentContainer.id);


            return uuid;
        };

        // 为指定的聊天区域添加推理容器
        window.createReasoningContainer = function (uuid) {
            if (!uuid) {
                console.error('UUID不能为空');
                return false;
            }

            // 检查是否已经存在推理容器
            if (document.getElementById('reasoning-' + uuid)) {
                console.warn('UUID为' + uuid + '的推理容器已存在');
                return true;
            }

            const chatContainer = document.getElementById('chat-' + uuid);
            if (!chatContainer) {
                console.error('找不到UUID为' + uuid + '的聊天容器');
                return false;
            }

            // 创建推理容器
            const reasoningContainer = document.createElement('div');
            reasoningContainer.className = 'reasoning-container';
            reasoningContainer.id = 'reasoning-' + uuid;

            // 创建推理标题栏
            const reasoningHeader = document.createElement('div');
            reasoningHeader.className = 'reasoning-header';
            reasoningHeader.innerHTML = `
                                                        <span class="reasoning-title">
                                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/>
                                                            </svg>
                                                            思考过程
                                                        </span>
                                                        <span class="reasoning-toggle">
                                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                                                <path d="M7 10l5 5 5-5z"/>
                                                            </svg>
                                                        </span>
                                                    `;

            // 添加点击事件以展开/折叠推理内容
            reasoningHeader.addEventListener('click', function () {
                reasoningContainer.classList.toggle('collapsed');
            });

            // 创建推理内容区域
            const reasoningContent = document.createElement('div');
            reasoningContent.className = 'reasoning-content';
            reasoningContent.id = 'reasoning-content-' + uuid;

            // 将推理标题和内容添加到推理容器
            reasoningContainer.appendChild(reasoningHeader);
            reasoningContainer.appendChild(reasoningContent);

            // 将推理容器插入到消息头部和内容之间
            const contentContainer = document.getElementById('content-' + uuid);
            chatContainer.insertBefore(reasoningContainer, contentContainer);

            // 创建推理渲染器
            window.reasoningRendererMap[uuid] = new MarkdownStreamRenderer(reasoningContent);

            return true;
        };

        // 添加用户滚动状态跟踪
        window.userScrollPosition = 0;
        window.autoScrollEnabled = true;


        // 修改 appendRenderer 函数
        window.appendRenderer = function (uuid, text) {
            if (!uuid) {
                return false;
            }

            // 检查是否存在推理容器，如果存在且未折叠，则自动折叠
            const reasoningContainer = document.getElementById('reasoning-' + uuid);
            if (reasoningContainer && !reasoningContainer.classList.contains('collapsed')) {
                reasoningContainer.classList.add('collapsed');
            }

            const renderer = window.rendererMap[uuid];
            if (renderer) {
                // 记录添加内容前的文档高度

                renderer.append(text);

                contentScroll();
                return true;
            } else {
                console.error('找不到UUID为' + uuid + '的渲染器');
                return false;
            }
        };

        // 添加推理内容的函数
        window.appendReasoning = function (uuid, text) {
            if (!uuid) {
                console.error('UUID不能为空');
                return false;
            }

            // 如果推理容器不存在，先创建它
            if (!document.getElementById('reasoning-' + uuid)) {
                if (!window.createReasoningContainer(uuid)) {
                    return false;
                }
            }

            const reasoningRenderer = window.reasoningRendererMap[uuid];
            if (reasoningRenderer) {
                // 添加内容
                reasoningRenderer.append(text);

                // 确保推理容器可见（在推理过程中）
                const reasoningContainer = document.getElementById('reasoning-' + uuid);
                if (reasoningContainer) {
                    reasoningContainer.classList.remove('collapsed');
                }
                // 获取推理内容区域并滚动到底部
                const reasoningContent = document.getElementById('reasoning-content-' + uuid);
                if (reasoningContent) {
                    reasoningContent.scrollTop = reasoningContent.scrollHeight;
                }
                contentScroll()
                return true;
            } else {
                console.error('找不到UUID为' + uuid + '的推理渲染器');
                return false;
            }
        };

        //下拉滚动条
        window.contentScroll = function () {
            if (document.getElementById("settings-scroll-checked").checked) {
                window.scrollTo(0, document.body.scrollHeight);
            }
        }

        // 完成推理过程，折叠推理区域
        window.completeReasoning = function (uuid) {
            if (!uuid) {
                console.error('UUID不能为空');
                return false;
            }

            const reasoningContainer = document.getElementById('reasoning-' + uuid);
            if (reasoningContainer) {
                // 添加一个短暂的延迟，让用户看到最终的推理结果
                setTimeout(() => {
                    reasoningContainer.classList.add('collapsed');
                }, 1000);
                return true;
            } else {
                console.error('找不到UUID为' + uuid + '的推理容器');
                return false;
            }
        };
        // 添加停止按钮点击处理函数
        function stopButton() {
            sendMessageToServer('InnerStopBtn_#');
            //// 切换回发送按钮
            //document.getElementById('send-button').style.display = 'flex';
            //document.getElementById('stop-button').style.display = 'none';
        };

        //消息接收完成的通知
        function processStreamComplete(uuid, totalTokens) {

            // 添加token展示
            const footerDiv = document.getElementById('footer-' + uuid);
            if (footerDiv) {
                footerDiv.innerHTML = `<span class="token-count">消耗token：${totalTokens}</span>`;
            }

            // 切换回发送按钮
            document.getElementById('send-button').style.display = 'flex';
            document.getElementById('stop-button').style.display = 'none';

            //折叠代码块区域
            // 首先获取对应uuid的内容区域
            const contentDiv = document.getElementById('content-' + uuid);
            if (contentDiv) {
                // 找到所有代码块
                const codeBlocks = contentDiv.querySelectorAll('pre code');
                codeBlocks.forEach(codeBlock => {
                    // 获取代码块的父元素
                    const preElement = codeBlock.parentElement;
                    if (preElement) {
                        // 如果父元素还没有折叠样式，添加折叠相关的样式和功能
                        if (!preElement.classList.contains('collapsible')) {
                            // 添加折叠样式类
                            preElement.classList.add('collapsible', 'collapsed');

                            // 创建展开/折叠标签
                            const toggleLabel = document.createElement('div');
                            toggleLabel.className = 'code-toggle-label';
                            toggleLabel.innerHTML = '点击展开代码';
                            toggleLabel.onclick = function (e) {
                                e.stopPropagation();
                                preElement.classList.toggle('collapsed');
                                toggleLabel.innerHTML = preElement.classList.contains('collapsed') ? '点击展开代码' : '点击折叠代码';
                            };

                            // 将标签插入到代码块前面
                            preElement.parentNode.insertBefore(toggleLabel, preElement);
                        }
                    }
                });
            }

            if (document.getElementById("chatMode").value === 'agent') {
                let executeBtns = document.getElementById("content-" + uuid).querySelector(".execute-button");
                if (executeBtns) {
                    executeBtns.click();
                }
            }
        }

        function chatModeChanged(select) {
            settingsSave()
        }

        // 生成UUID
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        function toggleChatMessageReference(headerElement) {
            const container = headerElement.closest('.chat-message-references');
            if (container) {
                container.classList.toggle('collapsed');
            }
        }

        // 格式化日期时间
        function formatDateTime(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');

            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        // 编辑代码函数
        function editCode(button) {
            const codeBlock = button.closest('.code-block');
            const codeElement = codeBlock.querySelector('code');
            const code = codeElement.textContent;
            const language = codeElement.className.replace('language-', '');

            // 创建编辑区域
            const editorContainer = document.createElement('div');
            editorContainer.className = 'editor-container';

            const textarea = document.createElement('textarea');
            textarea.className = 'code-editor';
            textarea.value = code;

            const buttonsDiv = document.createElement('div');
            buttonsDiv.className = 'editor-buttons';

            const saveButton = document.createElement('button');
            saveButton.className = 'code-button';
            saveButton.innerHTML = '保存';
            saveButton.onclick = function () {
                // 获取编辑后的代码
                const newCode = textarea.value;

                // 更新代码块
                const newCodeHtml = marked.parse('```' + language + '\n' + newCode + '\n```');

                // 替换整个代码块
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = newCodeHtml;
                const newCodeBlock = tempDiv.querySelector('.code-block');

                codeBlock.parentNode.replaceChild(newCodeBlock, codeBlock);

                // 重新应用语法高亮
                document.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });

                // 移除编辑区域
                editorContainer.remove();
            };

            const cancelButton = document.createElement('button');
            cancelButton.className = 'code-button';
            cancelButton.style.backgroundColor = '#f44336';
            cancelButton.innerHTML = '取消';
            cancelButton.onclick = function () {
                // 移除编辑区域，恢复代码块
                codeBlock.style.display = 'block';
                editorContainer.remove();
            };

            buttonsDiv.appendChild(cancelButton);
            buttonsDiv.appendChild(saveButton);

            editorContainer.appendChild(textarea);
            editorContainer.appendChild(buttonsDiv);

            // 隐藏原代码块，插入编辑区域
            codeBlock.style.display = 'none';
            codeBlock.parentNode.insertBefore(editorContainer, codeBlock);

            // 确保按钮可见
            textarea.focus();
            editorContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // 添加清空聊天内容的函数
        window.clearAllChats = function () {
            // 获取聊天容器
            const chatContainer = document.getElementById('chat-container');
            if (chatContainer) {
                // 清空容器内容
                chatContainer.innerHTML = '';

                // 清空渲染器映射
                window.rendererMap = {};
                window.reasoningRendererMap = {};

                // 重置自动滚动
                window.autoScrollEnabled = true;

                console.log('已清空所有聊天内容');
                return true;
            } else {
                console.error('找不到聊天容器');
                return false;
            }
        };
        // 获取整个聊天容器的HTML
        window.getFullChatHTML = function () {
            const chatContainer = document.getElementById('chat-container');
            if (chatContainer) {
                return chatContainer.innerHTML;
            }
            return '';
        };

        // 设置聊天容器的HTML
        window.setFullChatHTML = function (html) {
            const chatContainer = document.getElementById('chat-container');
            if (chatContainer) {
                // 清空现有内容
                chatContainer.innerHTML = '';

                // 设置新内容
                chatContainer.innerHTML = html;

                // 重建渲染器映射
                window.rebuildRendererMaps();

                return true;
            }
            return false;
        };

        // 重建渲染器映射
        window.rebuildRendererMaps = function () {
            // 清空现有映射
            window.rendererMap = {};
            window.reasoningRendererMap = {};

            // 查找所有内容和推理容器
            const contentContainers = document.querySelectorAll('.message-content');
            const reasoningContainers = document.querySelectorAll('.reasoning-content');

            // 重建内容渲染器映射
            contentContainers.forEach(container => {
                const id = container.id;
                if (id && id.startsWith('content-')) {
                    const uuid = id.replace('content-', '');
                    window.rendererMap[uuid] = new MarkdownStreamRenderer(id);
                }
            });

            // 重建推理渲染器映射
            reasoningContainers.forEach(container => {
                const id = container.id;
                if (id && id.startsWith('reasoning-content-')) {
                    const uuid = id.replace('reasoning-content-', '');
                    window.reasoningRendererMap[uuid] = new MarkdownStreamRenderer(id);
                }
            });

            console.log('已重建渲染器映射');
            return true;
        };

        // 自适应textarea高度
        const chatInput = document.getElementById('chat-input');

        // 展开/折叠引用区
        function toggleReference(uuid) {
            const ref = document.getElementById('reference-' + uuid);
            if (ref) {
                ref.classList.toggle('collapsed');
            }
        }

        function sendMessageToServer(messagePayload) { // Modified to accept a payload
            if (window.chrome && window.chrome.webview) {
                window.chrome.webview.postMessage(messagePayload); // Send the whole payload
            } else if (window.vsto) {
                if (typeof window.vsto.sendMessage === 'function') {
                    if (messagePayload.type === 'sendMessage' && typeof messagePayload.value === 'object') {
                        window.vsto.sendMessage(JSON.stringify(messagePayload.value));
                    } else {
                        window.vsto.sendMessage(messagePayload); // Or adjust as per vsto.sendMessage signature
                    }
                } else if (typeof window.vsto.postMessage === 'function') { // Fallback if postMessage exists on vsto
                    window.vsto.postMessage(messagePayload);
                }
            } else {
                alert('无法执行代码：未检测到支持的通信接口');
            }
        }
        function sendChatMessage() {
            const userTypedText = chatInput.value.trim(); // 用户的原始输入
            const attachedFileObjects = window.attachedFiles; // 保持 File 对象数组
            const selectedSheetContent = window.getAllSelectedContent(); // 获取选中的工作表内容

            // 检查是否有任何内容发送
            if (!userTypedText && attachedFileObjects.length === 0 && selectedSheetContent.length === 0) return;

            document.getElementById('send-button').style.display = 'none';
            document.getElementById('stop-button').style.display = 'flex';

            // 准备发送到后端的数据
            const messagePayloadValue = {
                text: userTypedText,
                filePaths: attachedFileObjects.map(file => (file && typeof file.path === 'string' && file.path) ? file.path : file.name),
                selectedContent: selectedSheetContent
            };

            sendMessageToServer({
                type: 'sendMessage',
                value: messagePayloadValue
            });

            const uuid = generateUUID();
            const now = new Date();
            const timestamp = formatDateTime(now);

            // 1. 创建基本的聊天节（头像、名称、时间戳、空的 message-content div）
            createChatSection('Me', timestamp, uuid);

            // 2. 获取刚创建的 message-content div
            const messageContentDiv = document.getElementById('content-' + uuid);
            if (!messageContentDiv) {
                console.error('Could not find message content div for ' + uuid);
                return;
            }

            // 3. 构建并设置 message-content div 的 innerHTML
            let htmlContent = '';

            // 3a. 添加用户输入的文本 (Markdown 解析)
            if (userTypedText) {
                htmlContent += marked.parse(userTypedText);
            }

            // 3b. 添加可折叠的 "引用内容"
            if (selectedSheetContent.length > 0) {
                let itemsHtml = selectedSheetContent.map(item => `<div>${item.sheetName}: ${item.address}</div>`).join('');
                htmlContent += `
                    <div class="chat-message-references collapsed" id="msg-ref-sel-${uuid}">
                        <div class="chat-message-reference-header" onclick="toggleChatMessageReference(this)">
                            <span class="chat-message-reference-arrow">&#9658;</span>
                            <span class="chat-message-reference-label">引用内容 (${selectedSheetContent.length})</span>
                        </div>
                        <div class="chat-message-reference-content">
                            ${itemsHtml}
                        </div>
                    </div>`;
            }

            // 3c. 添加可折叠的 "引用文件"
            if (attachedFileObjects.length > 0) {
                let displayItemsHtml = attachedFileObjects.map(file => `<div>${escapeHtml(file.name)}</div>`).join('');
                htmlContent += `
        <div class="chat-message-references collapsed" id="msg-ref-file-${uuid}">
            <div class="chat-message-reference-header" onclick="toggleChatMessageReference(this)">
                <span class="chat-message-reference-arrow">&#9658;</span>
                <span class="chat-message-reference-label">引用文件 (${attachedFileObjects.length})</span>
            </div>
            <div class="chat-message-reference-content">
                ${displayItemsHtml}
            </div>
        </div>`;
            }

            messageContentDiv.innerHTML = htmlContent;

            // 3d. 如果用户文本中包含代码块，需要重新高亮
            messageContentDiv.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
                // 如果需要，这里也可以重新附加代码块的复制/编辑/执行按钮逻辑
                // 但由于 marked.parse 已经处理了按钮，可能不需要重复
            });

            // 4. 清空输入区域的引用和文本框
            window.selectedContentMap = {};
            window.attachedFiles = []; // 清空 File 对象数组
            renderReferences(); // 更新输入区域的引用显示

            chatInput.value = '';
            chatInput.style.height = 'auto'; // 重置输入框高度
            hidePromptSuggestions();

            // 5. 滚动到最新消息
            //contentScroll();
        }

        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        // 发送按钮点击
        document.getElementById('send-button').onclick = sendChatMessage;


        // 回车发送，Shift+Enter换行
        chatInput.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendChatMessage();
            }
        });


        window.selectedContentMap = {}; // { sheetName: Set(address1, address2, ...) }

        // 添加选中内容（支持Ctrl多选，否则单选）
        window.addSelectedContentItem = function (sheetName, address, ctrlKey) {
            if (!address || address.trim() === '') {
                return;
            }
            const newItemId = generateUUID();
            const newItem = { id: newItemId, address: address.trim() };

            if (!ctrlKey) {
                //window.selectedContentMap = {};
                window.selectedContentMap[sheetName] = newItem;
            } else {
                window.selectedContentMap[sheetName] = newItem;
            }
            renderReferences(); // <--- 更新调用
        };

        // 移除单个内容
        // 修改后：通过itemId移除
        window.removeSelectedContentItem = function (itemIdToRemove) {
            for (const sheetName in window.selectedContentMap) {
                if (window.selectedContentMap.hasOwnProperty(sheetName)) {
                    if (window.selectedContentMap[sheetName] && window.selectedContentMap[sheetName].id === itemIdToRemove) {
                        delete window.selectedContentMap[sheetName];
                        break;
                    }
                }
            }
            renderReferences(); // <--- 更新调用
        };


        // 获取所有选中内容
        // 修改后：适配新的selectedContentMap结构
        window.getAllSelectedContent = function () {
            const arr = [];
            for (const sheetName in window.selectedContentMap) {
                if (window.selectedContentMap.hasOwnProperty(sheetName)) {
                    const selectedItem = window.selectedContentMap[sheetName];
                    if (selectedItem) {
                        // 可以选择是否也返回id，取决于其他地方是否需要
                        arr.push({ sheetName: sheetName, address: selectedItem.address, id: selectedItem.id });
                    }
                }
            }
            return arr;
        };

        // 自适应textarea高度 和 提示词建议逻辑
        const promptSuggestionsDiv = document.getElementById('prompt-suggestions');
        const attachFileButton = document.getElementById('attach-file-button');
        const fileInput = document.getElementById('file-input');

        // 获取新的统一引用区域的元素
        const referencesWrapper = document.getElementById('references-wrapper');
        const referencesTitle = document.getElementById('references-title'); // 应该已在HTML中设置为 "引用:"
        const referenceChipsList = document.getElementById('reference-chips-list');


        window.attachedFiles = []; // Array to store selected File objects
        window.selectedContentMap = {}; 

        // 预定义的提示词列表
        const predefinedPrompts = [
            "帮我把A列加B列的值写入C列",
            "帮我把Sheet1和Sheet2的表格按名字合并",
            "帮我把Sheet1的数据，按照中文名称拆分成多个xlsx文件",
            "给我将我选中的Word内容格式调整一下",
            "给我生成一个3页的周报PPT文件"
        ];

        function showPromptSuggestions() {
            promptSuggestionsDiv.innerHTML = ''; // 清空旧建议
            predefinedPrompts.forEach(promptText => {
                const item = document.createElement('div');
                item.className = 'prompt-suggestion-item';
                item.textContent = promptText;
                item.onclick = function () {
                    chatInput.value = promptText;
                    hidePromptSuggestions();
                    chatInput.focus();
                    // 触发input事件以调整高度
                    const event = new Event('input', { bubbles: true, cancelable: true });
                    chatInput.dispatchEvent(event);
                };
                promptSuggestionsDiv.appendChild(item);
            });
            promptSuggestionsDiv.style.display = 'block';
        }

        function hidePromptSuggestions() {
            promptSuggestionsDiv.style.display = 'none';
        }


        // --- 新的统一渲染函数 ---
        function renderReferences() {
            if (!referencesWrapper || !referenceChipsList || !referencesTitle) {
                console.error("Reference display elements not found!");
                return;
            }

            referenceChipsList.innerHTML = ''; // 清空所有现有的chips
            let hasAnyReferences = false;

            // 1. 渲染选中的工作表内容
            for (const sheetName in window.selectedContentMap) {
                if (window.selectedContentMap.hasOwnProperty(sheetName)) {
                    const selectedItem = window.selectedContentMap[sheetName];
                    if (!selectedItem) continue;
                    hasAnyReferences = true;

                    const itemChip = document.createElement('div');
                    itemChip.className = 'reference-chip';
                    itemChip.title = `${sheetName} [${selectedItem.address}]`;

                    const chipContentWrapper = document.createElement('div');
                    chipContentWrapper.className = 'reference-chip-content-wrapper';

                    const itemNameSpan = document.createElement('span');
                    itemNameSpan.className = 'reference-chip-name';
                    itemNameSpan.textContent = `${sheetName}: ${selectedItem.address}`;
                    chipContentWrapper.appendChild(itemNameSpan);

                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'reference-chip-remove';
                    removeBtn.title = '移除此引用';
                    removeBtn.innerHTML = `<svg viewBox="0 0 20 20"><line x1="5" y1="5" x2="15" y2="15" stroke="currentColor" stroke-width="2"/><line x1="15" y1="5" x2="5" y2="15" stroke="currentColor" stroke-width="2"/></svg>`;
                    removeBtn.onclick = function () {
                        removeSelectedContentItem(selectedItem.id); // 调用已有的移除函数
                    };
                    chipContentWrapper.appendChild(removeBtn);
                    itemChip.appendChild(chipContentWrapper);
                    referenceChipsList.appendChild(itemChip);
                }
            }

            // 2. 渲染附加的文件
            window.attachedFiles.forEach((file, index) => {
                hasAnyReferences = true;
                const itemChip = document.createElement('div');
                itemChip.className = 'reference-chip';
                itemChip.title = file.name;

                const chipContentWrapper = document.createElement('div');
                chipContentWrapper.className = 'reference-chip-content-wrapper';

                const fileNameSpan = document.createElement('span');
                fileNameSpan.className = 'reference-chip-name';
                fileNameSpan.textContent = file.name;
                chipContentWrapper.appendChild(fileNameSpan);

                const removeBtn = document.createElement('button');
                removeBtn.className = 'reference-chip-remove';
                removeBtn.title = '移除此文件';
                removeBtn.innerHTML = `<svg viewBox="0 0 20 20"><line x1="5" y1="5" x2="15" y2="15" stroke="currentColor" stroke-width="2"/><line x1="15" y1="5" x2="5" y2="15" stroke="currentColor" stroke-width="2"/></svg>`;
                removeBtn.onclick = function () {
                    window.attachedFiles.splice(index, 1);
                    renderReferences(); // 重新渲染整个引用区域
                };
                chipContentWrapper.appendChild(removeBtn);
                itemChip.appendChild(chipContentWrapper);
                referenceChipsList.appendChild(itemChip);
            });

            // 3. 控制整个引用区域的显示/隐藏
            if (hasAnyReferences) {
                referencesWrapper.style.display = 'block'; // 或者 'flex' 如果 #references-wrapper 本身是flex容器
            } else {
                referencesWrapper.style.display = 'none';
            }
        }

        // --- Attachment Logic ---
        attachFileButton.addEventListener('click', () => {
            fileInput.value = ''; // Clear previous selection from file input
            fileInput.click();
        });

        fileInput.addEventListener('change', function (event) {
            const files = event.target.files;
            if (!files) return;
            const allowedExtensions = /(\.xls|\.xlsx|\.xlsm|\.xlsb|\.csv|\.doc|\.docx|\.ppt|\.pptx)$/i;
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (!allowedExtensions.exec(file.name)) {
                    alert(`文件类型不支持: ${file.name}`);
                    continue;
                }
                const isDuplicate = window.attachedFiles.some(
                    existingFile => existingFile.name === file.name && existingFile.size === file.size
                );
                if (isDuplicate) {
                    console.log(`文件已添加: ${file.name}`);
                    continue;
                }
                window.attachedFiles.push(file);
            }
            renderReferences(); // <--- 更新调用
            fileInput.value = '';
        });

        // --- End Attachment Logic ---


        chatInput.addEventListener('input', function () {
            // 自适应高度
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';

            // 提示词逻辑
            const value = this.value;
            if (value === '#') {
                showPromptSuggestions();
            } else if (!value.startsWith('#') || value.length > 1) {
                hidePromptSuggestions();
            }
        });

        // 如果用户点击textarea外部，也隐藏提示词
        document.addEventListener('click', function (event) {
            if (!chatInput.contains(event.target) && !promptSuggestionsDiv.contains(event.target) && !attachFileButton.contains(event.target)) {
                if (!event.target.closest('.reference-chip-remove')) { // Don't hide if clicking remove on a chip
                    hidePromptSuggestions();
                }
            }
        });

        function settingsButton() {
            // 显示遮罩和对话框
            document.getElementById('settings-overlay').style.display = 'block';
            document.getElementById('settings-dialog').style.display = 'block';
        }

        function settingsCancel() {
            document.getElementById('settings-overlay').style.display = 'none';
            document.getElementById('settings-dialog').style.display = 'none';
        }

        function settingsSave() {
            let topicRandomness = document.getElementById('topic-randomness').value
            let contextLimit = document.getElementById('context-limit').value
            let settingsScroll = document.getElementById('settings-scroll-checked').checked
            let selectedCell = document.getElementById('settings-selected-cell').checked
            let chatMode = document.getElementById("chatMode").value

            // 保存随机性和上下文限制的设置
            if (window.chrome && window.chrome.webview) {
                // ues WebView2
                window.chrome.webview.postMessage({
                    type: 'saveSettings',
                    topicRandomness: topicRandomness,
                    contextLimit: contextLimit,
                    selectedCell: selectedCell,
                    settingsScroll: settingsScroll,
                    chatMode: chatMode,
                });
            } else if (window.vsto) {
                // user inject vsto object
                window.vsto.saveSettings({
                    topicRandomness: topicRandomness,
                    contextLimit: contextLimit,
                    selectedCell: selectedCell,
                    settingsScroll: settingsScroll,
                    chatMode: chatMode,
                });
            } else {
                alert('无法执行代码：未检测到支持的通信接口');
            }

            // 关闭对话框
            document.getElementById('settings-overlay').style.display = 'none';
            document.getElementById('settings-dialog').style.display = 'none';
        }


        // 滑块值实时更新
        document.getElementById('topic-randomness').oninput = function () {
            document.getElementById('topic-randomness-value').textContent =
                Number(this.value).toFixed(1);
        };

        document.getElementById('context-limit').oninput = function () {
            document.getElementById('context-limit-value').textContent = this.value;
        };

        // 点击遮罩关闭对话框
        document.getElementById('settings-overlay').onclick = function () {
            document.getElementById('settings-overlay').style.display = 'none';
            document.getElementById('settings-dialog').style.display = 'none';
        };
    </script>
</body>
</html>