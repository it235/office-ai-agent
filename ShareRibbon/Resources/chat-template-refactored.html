<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat</title>
    <!-- Third-party libraries - using virtual host officeai.local -->
    <script src="https://officeai.local/js/marked.min.js"></script>
    <script src="https://officeai.local/js/highlight.min.js"></script>
    <script src="https://officeai.local/js/vbscript.min.js"></script>
    <link rel="stylesheet" href="https://officeai.local/css/github.min.css">
    <!-- Custom styles -->
    <link rel="stylesheet" href="https://officeai.local/css/styles.css">
</head>
<body>
    <div id="case-container">
        <div id="case-header" style="position:relative; background: linear-gradient(135deg, #4a6fa5 0%, #3d5a7c 100%); padding: 5px 25px; color: white; border-bottom: 1px solid rgba(255,255,255,0.1); cursor:pointer;">
            <h3 style="margin:0; font-size:1.3em; font-weight:400; letter-spacing:0.5px;">智能聊天模式说明</h3>
            <span id="case-toggle-arrow" style="position:absolute; right:18px; top:50%; transform:translateY(-50%) rotate(-90deg); display:flex; align-items:center; transition:transform 0.2s;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                     stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
            </span>
        </div>
        <div id="case-content" class="collapsed">
            <div id="case-info">
                <p>1.试试按#号快速提问</p>
                <p>2.会话已自动开启上下文，您可通过不断提问纠正AI的回答</p>
                <p>3.使用前请配置大模型Api，<a href="https://cloud.siliconflow.cn/i/PGhr3knx" target="_blank">点此取免费额度</a></p>
                <p>4.配置大模型提示词能够更快，更准确的得到你想要的答案</p>
                <p>5.如果没解决你的痛点，<a href="https://jsj.top/f/OZJDfa" target="_blank">点击此处提出需求</a>，下个版本见</p>
                <p>6.聊天记录存放在"当前用户/文档/OfficeAiAppData"目录下</p>
                <p>7.当前版本:<span id="version">2.6.4</span>，<a href="https://www.officeso.cn" target="_blank">每月发布新功能</a></p>
            </div>
        </div>
    </div>

    <div id="chat-container">
        <!-- message content list -->
    </div>

    <!-- message chat input bottom -->
    <div id="chat-bottom-bar">

        <!-- message input -->
        <div id="chat-input-card">
            <div id="chat-input-inner">
                <!-- 合并后的引用区域 -->
                <div id="references-wrapper" style="display:none;">
                    <span id="references-title" class="reference-section-title">引用:</span>
                    <div id="reference-chips-list" class="reference-chips-container">
                        <!-- 所有引用项（工作表内容和文件）将在此处动态添加 -->
                    </div>
                </div>

                <div id="prompt-suggestions" style="display: none;">
                    <!-- 提示词项将在此处动态添加 -->
                </div>

                <!-- 自动补全下拉列表 -->
                <div id="autocomplete-dropdown" class="autocomplete-dropdown hidden">
                    <div class="autocomplete-header">
                        <span>AI 建议</span>
                        <span class="autocomplete-hint">Tab 采纳 · ↑↓ 切换 · Esc 关闭</span>
                    </div>
                    <ul id="autocomplete-list"></ul>
                </div>

                <!-- 智能输入框容器 -->
                <div class="smart-input-container">
                    <div id="smart-input" contenteditable="true" class="smart-input" 
                         data-placeholder="请在此输入您的问题... 按Enter键直接发送，Tab采纳补全"></div>
                    <span id="ghost-text" class="ghost-text"></span>
                </div>
                <!-- 隐藏的textarea用于兼容现有发送逻辑 -->
                <textarea id="chat-input" style="display:none;" placeholder="请在此输入您的问题..." rows="2"></textarea>
                <div id="chat-input-actions">

                    <button id="settings-button" title="设置" onclick="settingsButton()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                        </svg>
                    </button>

                    <label class="input-option">
                        <select id="chatMode" onchange="chatModeChanged(this)">
                            <option value="chat">Chat模式</option>
                            <option value="agent">Agent模式</option>
                        </select>
                    </label>

                    <!-- 新增：附件按钮 -->
                    <button id="attach-file-button" title="添加附件" style="padding: 4px;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
                        </svg>
                    </button>
                    <input type="file" id="file-input" multiple style="display: none;" accept=".xls,.xlsx,.xlsm,.xlsb,.csv,.doc,.docx,.ppt,.pptx">

                    <!-- 新增：AI续写按钮 -->
                    <button id="continuation-button" title="AI续写" onclick="triggerContinuation(false)" style="padding: 4px;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </button>

                    <button id="send-button" title="发送">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 20px; height: 20px;">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </button>

                    <!-- 取消正在发送的消息 -->
                    <button id="stop-button" title="取消" onclick="stopButton()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16">
                            <rect x="3" y="3" width="10" height="10" fill="white" rx="1"></rect>
                        </svg>
                    </button>

                    <!-- MCP 按钮 -->
                    <button id="mcp-toggle-btn" title="配置MCP工具">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
                        </svg>
                    </button>

                    <button id="clear-context-btn" title="清理记忆或聊天记录">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 6h18"></path>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path>
                            <path d="M10 11v6"></path>
                            <path d="M14 11v6"></path>
                            <path d="M9 3V4a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2V3"></path>
                        </svg>
                    </button>

                    <!-- 新增：历史记录按钮，放在取消按钮之后 -->
                    <button id="history-toggle-btn" title="查看历史聊天记录">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12,6 12,12 16,14"></polyline>
                        </svg>
                    </button>

                </div>
            </div>
        </div>
    </div>

    <!-- MCP 配置弹窗 -->
    <div id="mcp-dialog">
        <div class="mcp-dialog-header">
            <span class="mcp-dialog-title">MCP工具配置</span>
            <button class="mcp-close-btn" id="mcp-close-btn">&times;</button>
        </div>
        <div id="mcp-list" class="mcp-list">
            <!-- MCP列表将在这里动态生成 -->
        </div>
        <div class="mcp-dialog-footer">
            <button class="mcp-save-btn" id="mcp-save-btn">保存设置</button>
        </div>
    </div>

    <!-- MCP弹窗遮罩 -->
    <div class="overlay" id="mcp-overlay"></div>

    <!-- 历史记录侧边栏 -->
    <div id="history-sidebar" class="sidebar-hidden">
        <div class="sidebar-header">
            <h3>历史聊天记录</h3>
            <button id="close-sidebar-btn" title="关闭">×</button>
        </div>
        <div class="sidebar-content">
            <div id="history-list">
                <!-- 历史记录列表将在这里动态加载 -->
            </div>
        </div>
    </div>

    <!-- 遮罩层 -->
    <div id="sidebar-overlay" class="overlay-hidden"></div>

    <!-- 添加设置对话框 -->
    <div class="overlay" id="settings-overlay"></div>
    <div class="settings-dialog" id="settings-dialog">
        <div class="settings-title">AI对话设置</div>

        <div class="setting-item checkbox-item">
            <div>
                <label class="setting-label">实时滚动对话内容</label>
                <input type="checkbox" id="settings-scroll-checked">
            </div>
            <div class="setting-tip">开启后会自动滚动到最新的对话内容</div>
        </div>

        <div class="setting-item checkbox-item">
            <div>
                <label class="setting-label">引用选中内容</label>
                <input type="checkbox" id="settings-selected-cell">
            </div>
            <div class="setting-tip">开启后可以选择并引用工作表内容</div>
        </div>

        <div class="setting-item checkbox-item">
            <div>
                <label class="setting-label">工作表变更预览</label>
                <input type="checkbox" id="settings-executecode-preview">
            </div>
            <div class="setting-tip">开启后，Agent模式下可提前预览变更点，对比差异</div>
        </div>

        <div class="setting-item checkbox-item">
            <div>
                <label class="setting-label">AI智能补全</label>
                <input type="checkbox" id="settings-autocomplete-enable">
            </div>
            <div class="setting-tip">开启后，输入时AI会自动识别意图并提供补全建议</div>
        </div>
        
        <div class="setting-item">
            <label class="setting-label">补全快捷键</label>
            <select id="settings-autocomplete-shortcut" style="padding: 4px 8px; border-radius: 4px; border: 1px solid #ccc;">
                <option value="Ctrl+.">Ctrl + .</option>
                <option value="Alt+/">Alt + /</option>
                <option value="Ctrl+Enter">Ctrl + Enter</option>
                <option value="Alt+Enter">Alt + Enter</option>
            </select>
            <div class="setting-tip">选择接受补全建议的快捷键组合</div>
        </div>

        <div class="setting-item">
            <label class="setting-label">话题随机性</label>
            <div class="slider-container">
                <input type="range" class="slider" id="topic-randomness" min="0.1" max="1.6" step="0.1" value="0.8">
                <span class="slider-value" id="topic-randomness-value">0.8</span>
            </div>
            <div class="setting-tip">较高的数值会使同问题每次输出的结果更随机</div>
        </div>

        <div class="setting-item">
            <label class="setting-label">上下文数量限制</label>
            <div class="slider-container">
                <input type="range" class="slider" id="context-limit" min="1" max="10" value="5">
                <span class="slider-value" id="context-limit-value">5</span>
            </div>
            <div class="setting-tip">单条回复记录对话数，每次想让ai记住历史多少条对话</div>
        </div>

        <div class="settings-buttons">
            <button class="settings-button cancel-button" id="settings-cancel" onclick="settingsCancel()">取消</button>
            <button class="settings-button save-button" id="settings-save" onclick="settingsSave()">保存</button>
        </div>
    </div>

    <!-- 2. 修改弹窗内容为三选一 -->
    <div id="clear-or-delete-actions" style="display:none; position:fixed; bottom:80px; left:50%; transform:translateX(-50%); z-index:999;">
        <div style="background:white; border-radius:8px; box-shadow:0 2px 12px rgba(0,0,0,0.12); padding:18px 18px;">
            <div style="font-size:15px; margin-bottom:16px;">选择你要进行的操作：</div>
            <button id="action-clear-context" style="background: #4a6fa5; color: white; border: none; padding: 5px 5px; border-radius: 6px; margin-right: 10px; margin-bottom: 2px;">清空聊天上下文记忆</button>
            <button id="action-delete-chat" style="background: #e9525f; color: white; border: none; padding: 5px 5px; border-radius: 6px; margin-right: 10px; margin-bottom: 2px; ">批量删除聊天记录</button>
            <button id="action-cancel" style="background:#f5f5f5;color:#333;border:none;padding:5px 10px;border-radius:6px;">我可能点错了</button>
        </div>
    </div>

    <!-- 删除聊天 -->
    <div id="delete-chat-actions" style="display:none; position:fixed; bottom:80px; left:50%; transform:translateX(-50%); z-index:999;">
        <button id="confirm-delete-chat" style="background:#e9525f;color:white;border:none;padding:6px 16px;border-radius:6px;margin-right:10px;">确定删除</button>
        <button id="cancel-delete-chat" style="background:#f5f5f5;color:#333;border:none;padding:6px 16px;border-radius:6px;">取消</button>
    </div>

    <!-- Custom JavaScript modules (order matters due to dependencies) - using virtual host officeai.local -->
    <script src="https://officeai.local/js/utils.js"></script>
    <script src="https://officeai.local/js/markdown-renderer.js"></script>
    <script src="https://officeai.local/js/core.js"></script>
    <script src="https://officeai.local/js/chat-manager.js"></script>
    <script src="https://officeai.local/js/message-sender.js"></script>
    <script src="https://officeai.local/js/code-handler.js"></script>
    <script src="https://officeai.local/js/settings-manager.js"></script>
    <script src="https://officeai.local/js/mcp-manager.js"></script>
    <script src="https://officeai.local/js/history-manager.js"></script>
    <script src="https://officeai.local/js/revision-manager.js"></script>
    <script src="https://officeai.local/js/autocomplete.js"></script>
</body>
</html>
